@using HomeManager.Data.Data.Models.Enums
@model IEnumerable<HomeManager.Data.Data.Dtos.HomeDto>

<h2>Advanced Estate Search</h2>
<form method="get" asp-controller="Search" asp-action="List" class="row g-3 mb-4">
    <div class="col-md-3">
        <input type="text" name="query" class="form-control" placeholder="Search by name or description" />
    </div>
    <div class="col-md-2">
        <select name="homeType" class="form-control">
            <option value="">All Types</option>
            @foreach (var type in Enum.GetValues(typeof(HomeType)))
            {
                <option value="@type">@type</option>
            }
        </select>
    </div>
    <div class="col-md-2">
        <input type="number" name="minPrice" class="form-control" placeholder="Min Price" />
    </div>
    <div class="col-md-2">
        <input type="number" name="maxPrice" class="form-control" placeholder="Max Price" />
    </div>
    <div class="col-md-2">
        <input type="text" name="region" class="form-control" placeholder="Region" />
    </div>
    <div class="col-md-2">
        <input type="text" name="city" class="form-control" placeholder="City/Town" />
    </div>
    <div class="col-md-2">
        <button type="submit" class="btn btn-hm w-100">Search</button>
    </div>
</form>

<div class="mb-3">
    <input id="mapSearchInput" type="text" class="form-control" placeholder="Search location..." />
    <button id="mapSearchBtn" class="btn btn-primary mt-2">Search</button>
</div>
<div id="map" style="height:400px;width:100%;"></div>
<script>
    var estates = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model));
    let map, marker, geocoder;
    function initMap() {
        geocoder = new google.maps.Geocoder();
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 42.6977, lng: 23.3219 },
            zoom: 10
        });

        var bounds = new google.maps.LatLngBounds();
        var infoWindow = new google.maps.InfoWindow();
        estates.forEach(function (estate) {
            if (estate.Latitude && estate.Longitude) {
                var pos = { lat: estate.Latitude, lng: estate.Longitude };
                var marker = new google.maps.Marker({
                    map: map,
                    position: pos,
                    title: estate.HomeName
                });
                marker.addListener('click', function () {
                    infoWindow.setContent(
                        '<div><strong>' + estate.HomeName + '</strong><br>' +
                        '<a id="mapSearchInput" href="/Homes/Details/' + estate.Id + '">View Details</a></div>'
                    );
                    infoWindow.open(map, marker);
                });
                bounds.extend(pos);
            }
        });
        if (!bounds.isEmpty()) {
            map.fitBounds(bounds);
        }
    }
    window.initMap = initMap;

    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("mapSearchBtn").addEventListener("click", function () {
            const address = document.getElementById("mapSearchInput").value;
            if (!address) return;
            geocoder.geocode({ address: address }, function (results, status) {
                if (status === "OK") {
                    map.setCenter(results[0].geometry.location);
                    if (marker) marker.setMap(null);
                    marker = new google.maps.Marker({
                        map: map,
                        position: results[0].geometry.location
                    });
                } else {
                    alert("Geocode was not successful: " + status);
                }
            });
        });
    });
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAJ9L4-eFlTuD7QWvoLbEkUb6d0LA6Bmmk&callback=initMap" async defer></script>
