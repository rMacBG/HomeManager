@using HomeManager.Data.Data.ViewModels
@model IEnumerable<ConversationListItemViewModel>

<h2>My Chats</h2>

@if (!Model.Any())
{
    <p>You do not have any active conversations.</p>
}
else
{
    <ul class="conversation-list">
        @*await Html.PartialAsync("_ChatBox") *@
        @foreach (var conversation in Model)
        {
            <li>
                <a href="javascript:void(0);"
                   data-conversation-id= "@conversation.ConversationId"
                   class="open-chat-link">
                    <strong>@conversation.OtherParticipantName</strong>
                    
                    <br />
                    <small>@conversation.CreatedAt.ToString("g")</small>
                </a>
            </li>
        }
    </ul>
}

<div id="chatBoxContainer"></div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll(".open-chat-link").forEach(function (link) {
                link.addEventListener("click", async function () {
                    const conversationId = this.dataset.conversationId;
                        console.log("Clicked conversation link. ID:", conversationId);
                    fetch(`/Chat/ChatBoxPartial?conversationId=${conversationId}`)
    .then(response => {
        if (!response.ok) throw new Error("Failed to load chat box.");
        return response.text();
    })
    .then(html => {
        document.getElementById("chatBoxContainer").innerHTML = html;
    })
    .catch(err => {
        alert("Could not load chat: " + err);
    });
                });
            });
        });
    </script>
}
